"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const net_1 = require("net");
const reporter_1 = require("./reporter");
class GraphiteReporter extends reporter_1.Reporter {
    constructor(host = process.env.GRAPHITE_HOST || 'localhost', port = process.env.GRAPHITE_PORT || '2003', prefix = 'app') {
        super();
        this.host = host;
        this.port = port;
        this.prefix = prefix;
        this.socket = new net_1.Socket();
        this.reconnecting = false;
    }
    start() {
        this.socket.on('error', error => {
            if (!this.reconnecting) {
                this.reconnecting = true;
                this.emit('log', 'warn', `Lost connection to ${this.host}. Reconnect in 10 seconds: ${error}`);
                this.stop();
                setTimeout(() => {
                    this.reconnecting = false;
                    this.start();
                }, 10000);
            }
        });
        this.emit('log', 'verbose', `Connecting to graphite @ ${this.host}:${this.port}.`);
        this.socket.connect(parseInt(this.port), this.host, () => {
            this.emit('log', 'verbose', `Successfully connected to graphite @ ${this.host}:${this.port}.`);
            this.interval = setInterval(() => {
                this.report();
            }, this.reportInterval);
        });
    }
    report() {
        if (this.reconnecting)
            return;
        const timestamp = Date.now() / 1000;
        const metrics = this.getMetrics();
        if (metrics.gauges.length !== 0) {
            metrics.gauges.forEach(gauge => {
                this.reportGauge(gauge, timestamp);
            });
        }
        if (metrics.meters.length !== 0) {
            metrics.meters.forEach(meter => {
                this.reportMeter(meter, timestamp);
            });
        }
        if (metrics.timers.length !== 0) {
            metrics.timers.forEach(timer => {
                this.reportTimer(timer, timestamp);
            });
        }
        if (metrics.counters.length !== 0) {
            metrics.counters.forEach(counter => {
                this.reportCounter(counter, timestamp);
            });
        }
        if (metrics.histograms.length !== 0) {
            metrics.histograms.forEach(histogram => {
                this.reportHistogram(histogram, timestamp);
            });
        }
    }
    send(name, value, timestamp) {
        if (this.reconnecting)
            return;
        this.socket.write(`${this.prefix}.${name} ${value} ${timestamp}\n`);
    }
    reportGauge(gauge, timestamp) {
        if (gauge) {
            this.send(gauge.name, gauge.toJSON(), timestamp);
        }
    }
    reportCounter(counter, timestamp) {
        if (counter) {
            this.send(counter.name, counter.toJSON(), timestamp);
        }
    }
    reportMeter(meter, timestamp) {
        if (meter) {
            this.reportMeterMetrics(meter.name, meter.toJSON(), timestamp);
        }
    }
    reportHistogram(histogram, timestamp) {
        if (histogram) {
            this.send(`${histogram.name}.count`, histogram.count, timestamp);
            this.reportHistogramMetrics(histogram.name, histogram.toJSON(), timestamp);
        }
    }
    reportTimer(timer, timestamp) {
        if (timer) {
            const timerObject = timer.toJSON();
            const meter = timerObject.meter;
            const histogram = timerObject.histogram;
            this.reportMeterMetrics(timer.name, meter, timestamp);
            this.reportHistogramMetrics(timer.name, histogram, timestamp);
        }
    }
    reportMeterMetrics(name, meterObject, timestamp) {
        this.send(`${name}.count`, meterObject.count, timestamp);
        this.send(`${name}.mean_rate`, meterObject.mean, timestamp);
        this.send(`${name}.m1_rate`, meterObject['1MinuteRate'], timestamp);
        this.send(`${name}.m5_rate`, meterObject['5MinuteRate'], timestamp);
        this.send(`${name}.m15_rate`, meterObject['15MinuteRate'], timestamp);
    }
    reportHistogramMetrics(name, histogramObject, timestamp) {
        Object.keys(histogramObject).forEach(key => {
            this.send(`${name}.${key}`, histogramObject[key], timestamp);
        });
    }
}
exports.GraphiteReporter = GraphiteReporter;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ3JhcGhpdGUtcmVwb3J0ZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvZ3JhcGhpdGUtcmVwb3J0ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSw2QkFBNkI7QUFFN0IseUNBQXNDO0FBRXRDLE1BQWEsZ0JBQWlCLFNBQVEsbUJBQVE7SUFHNUMsWUFDVSxPQUFlLE9BQU8sQ0FBQyxHQUFHLENBQUMsYUFBYSxJQUFJLFdBQVcsRUFDdkQsT0FBZSxPQUFPLENBQUMsR0FBRyxDQUFDLGFBQWEsSUFBSSxNQUFNLEVBQ2xELFNBQWlCLEtBQUs7UUFFOUIsS0FBSyxFQUFFLENBQUM7UUFKQSxTQUFJLEdBQUosSUFBSSxDQUFtRDtRQUN2RCxTQUFJLEdBQUosSUFBSSxDQUE4QztRQUNsRCxXQUFNLEdBQU4sTUFBTSxDQUFnQjtRQUx4QixXQUFNLEdBQVcsSUFBSSxZQUFNLEVBQUUsQ0FBQztRQUM5QixpQkFBWSxHQUFZLEtBQUssQ0FBQztJQU90QyxDQUFDO0lBRU0sS0FBSztRQUNWLElBQUksQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLE9BQU8sRUFBRSxLQUFLLENBQUMsRUFBRTtZQUM5QixJQUFJLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRTtnQkFDdEIsSUFBSSxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUM7Z0JBQ3pCLElBQUksQ0FBQyxJQUFJLENBQ1AsS0FBSyxFQUNMLE1BQU0sRUFDTixzQkFBc0IsSUFBSSxDQUFDLElBQUksOEJBQThCLEtBQUssRUFBRSxDQUNyRSxDQUFDO2dCQUVGLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztnQkFDWixVQUFVLENBQUMsR0FBRyxFQUFFO29CQUNkLElBQUksQ0FBQyxZQUFZLEdBQUcsS0FBSyxDQUFDO29CQUMxQixJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7Z0JBQ2YsQ0FBQyxFQUFFLEtBQUssQ0FBQyxDQUFDO2FBQ1g7UUFDSCxDQUFDLENBQUMsQ0FBQztRQUVILElBQUks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U0FBUyxDQUFDLENBQUM7U0FDL0Q7SUFDSCxDQUFDO0lBRU0sa0JBQWtCLENBQUMsSUFBSSxFQUFFLFdBQVcsRUFBRSxTQUFTO1FBQ3BELElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxJQUFJLFFBQVEsRUFBRSxXQUFXLENBQUMsS0FBSyxFQUFFLFNBQVMsQ0FBQyxDQUFDO1FBQ3pELElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxJQUFJLFlBQVksRUFBRSxXQUFXLENBQUMsSUFBSSxFQUFFLFNBQVMsQ0FBQyxDQUFDO1FBQzVELElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxJQUFJLFVBQVUsRUFBRSxXQUFXLENBQUMsYUFBYSxDQUFDLEVBQUUsU0FBUyxDQUFDLENBQUM7UUFDcEUsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLElBQUksVUFBVSxFQUFFLFdBQVcsQ0FBQyxhQUFhLENBQUMsRUFBRSxTQUFTLENBQUMsQ0FBQztRQUNwRSxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsSUFBSSxXQUFXLEVBQUUsV0FBVyxDQUFDLGNBQWMsQ0FBQyxFQUFFLFNBQVMsQ0FBQyxDQUFDO0lBQ3hFLENBQUM7SUFFTSxzQkFBc0IsQ0FBQyxJQUFJLEVBQUUsZUFBZSxFQUFFLFNBQVM7UUFDNUQsTUFBTSxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEVBQUU7WUFDekMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLElBQUksSUFBSSxHQUFHLEVBQUUsRUFBRSxlQUFlLENBQUMsR0FBRyxDQUFDLEVBQUUsU0FBUyxDQUFDLENBQUM7UUFDL0QsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0NBQ0Y7QUFwSUQsNENBb0lDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgU29ja2V0IH0gZnJvbSAnbmV0JztcblxuaW1wb3J0IHsgUmVwb3J0ZXIgfSBmcm9tICcuL3JlcG9ydGVyJztcblxuZXhwb3J0IGNsYXNzIEdyYXBoaXRlUmVwb3J0ZXIgZXh0ZW5kcyBSZXBvcnRlciB7XG4gIHByaXZhdGUgc29ja2V0OiBTb2NrZXQgPSBuZXcgU29ja2V0KCk7XG4gIHByaXZhdGUgcmVjb25uZWN0aW5nOiBib29sZWFuID0gZmFsc2U7XG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgaG9zdDogc3RyaW5nID0gcHJvY2Vzcy5lbnYuR1JBUEhJVEVfSE9TVCB8fCAnbG9jYWxob3N0JyxcbiAgICBwcml2YXRlIHBvcnQ6IHN0cmluZyA9IHByb2Nlc3MuZW52LkdSQVBISVRFX1BPUlQgfHwgJzIwMDMnLFxuICAgIHByaXZhdGUgcHJlZml4OiBzdHJpbmcgPSAnYXBwJ1xuICApIHtcbiAgICBzdXBlcigpO1xuICB9XG5cbiAgcHVibGljIHN0YXJ0KCkge1xuICAgIHRoaXMuc29ja2V0Lm9uKCdlcnJvcicsIGVycm9yID0+IHtcbiAgICAgIGlmICghdGhpcy5yZWNvbm5lY3RpbmcpIHtcbiAgICAgICAgdGhpcy5yZWNvbm5lY3RpbmcgPSB0cnVlO1xuICAgICAgICB0aGlzLmVtaXQoXG4gICAgICAgICAgJ2xvZycsXG4gICAgICAgICAgJ3dhcm4nLFxuICAgICAgICAgIGBMb3N0IGNvbm5lY3Rpb24gdG8gJHt0aGlzLmhvc3R9LiBSZWNvbm5lY3QgaW4gMTAgc2Vjb25kczogJHtlcnJvcn1gXG4gICAgICAgICk7XG4gICAgICAgIC8vIFN0b3AgdGhlIHJlcG9ydGVyIGFuZCB0cnkgYWdhaW4gaW4gYSBmZXcgc2Vjb25kcy5cbiAgICAgICAgdGhpcy5zdG9wKCk7XG4gICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgIHRoaXMucmVjb25uZWN0aW5nID0gZmFsc2U7XG4gICAgICAgICAgdGhpcy5zdGFydCgpO1xuICAgICAgICB9LCAxMDAwMCk7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICB0aGlzLmVtaXQoJ2xvZycsICd2ZXJib3NlJywgYENvbm5lY3RpbmcgdG8gZ3JhcGhpdGUgQCAke3RoaXMuaG9zdH06JHt0aGlzLnBvcnR9LmApO1xuICAgIHRoaXMuc29ja2V0LmNvbm5lY3QoXG4gICAgICBwYXJzZUludCh0aGlzLnBvcnQpLFxuICAgICAgdGhpcy5ob3N0LFxuICAgICAgKCkgPT4ge1xuICAgICAgICB0aGlzLmVtaXQoXG4gICAgICAgICAgJ2xvZycsXG4gICAgICAgICAgJ3ZlcmJvc2UnLFxuICAgICAgICAgIGBTdWNjZXNzZnVsbHkgY29ubmVjdGVkIHRvIGdyYXBoaXRlIEAgJHt0aGlzLmhvc3R9OiR7dGhpcy5wb3J0fS5gXG4gICAgICAgICk7XG4gICAgICAgIHRoaXMuaW50ZXJ2YWwgPSBzZXRJbnRlcnZhbCgoKSA9PiB7XG4gICAgICAgICAgdGhpcy5yZXBvcnQoKTtcbiAgICAgICAgfSwgdGhpcy5yZXBvcnRJbnRlcnZhbCk7XG4gICAgICB9XG4gICAgKTtcbiAgfVxuXG4gIHB1YmxpYyByZXBvcnQoKSB7XG4gICAgaWYgKHRoaXMucmVjb25uZWN0aW5nKSByZXR1cm47XG4gICAgY29uc3QgdGltZXN0YW1wID0gRGF0ZS5ub3coKSAvIDEwMDA7XG4gICAgY29uc3QgbWV0cmljcyA9IHRoaXMuZ2V0TWV0cmljcygpO1xuXG4gICAgaWYgKG1ldHJpY3MuZ2F1Z2VzLmxlbmd0aCAhPT0gMCkge1xuICAgICAgbWV0cmljcy5nYXVnZXMuZm9yRWFjaChnYXVnZSA9PiB7XG4gICAgICAgIHRoaXMucmVwb3J0R2F1Z2UoZ2F1Z2UsIHRpbWVzdGFtcCk7XG4gICAgICB9KTtcbiAgICB9XG4gICAgaWYgKG1ldHJpY3MubWV0ZXJzLmxlbmd0aCAhPT0gMCkge1xuICAgICAgbWV0cmljcy5tZXRlcnMuZm9yRWFjaChtZXRlciA9PiB7XG4gICAgICAgIHRoaXMucmVwb3J0TWV0ZXIobWV0ZXIsIHRpbWVzdGFtcCk7XG4gICAgICB9KTtcbiAgICB9XG4gICAgaWYgKG1ldHJpY3MudGltZXJzLmxlbmd0aCAhPT0gMCkge1xuICAgICAgbWV0cmljcy50aW1lcnMuZm9yRWFjaCh0aW1lciA9PiB7XG4gICAgICAgIHRoaXMucmVwb3J0VGltZXIodGltZXIsIHRpbWVzdGFtcCk7XG4gICAgICB9KTtcbiAgICB9XG4gICAgaWYgKG1ldHJpY3MuY291bnRlcnMubGVuZ3RoICE9PSAwKSB7XG4gICAgICBtZXRyaWNzLmNvdW50ZXJzLmZvckVhY2goY291bnRlciA9PiB7XG4gICAgICAgIHRoaXMucmVwb3J0Q291bnRlcihjb3VudGVyLCB0aW1lc3RhbXApO1xuICAgICAgfSk7XG4gICAgfVxuICAgIGlmIChtZXRyaWNzLmhpc3RvZ3JhbXMubGVuZ3RoICE9PSAwKSB7XG4gICAgICBtZXRyaWNzLmhpc3RvZ3JhbXMuZm9yRWFjaChoaXN0b2dyYW0gPT4ge1xuICAgICAgICB0aGlzLnJlcG9ydEhpc3RvZ3JhbShoaXN0b2dyYW0sIHRpbWVzdGFtcCk7XG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHNlbmQobmFtZSwgdmFsdWUsIHRpbWVzdGFtcCkge1xuICAgIGlmICh0aGlzLnJlY29ubmVjdGluZykgcmV0dXJuO1xuICAgIHRoaXMuc29ja2V0LndyaXRlKGAke3RoaXMucHJlZml4fS4ke25hbWV9ICR7dmFsdWV9ICR7dGltZXN0YW1wfVxcbmApO1xuICB9XG5cbiAgcHVibGljIHJlcG9ydEdhdWdlKGdhdWdlLCB0aW1lc3RhbXApIHtcbiAgICBpZiAoZ2F1Z2UpIHtcbiAgICAgIHRoaXMuc2VuZChnYXVnZS5uYW1lLCBnYXVnZS50b0pTT04oKSwgdGltZXN0YW1wKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgcmVwb3J0Q291bnRlcihjb3VudGVyLCB0aW1lc3RhbXApIHtcbiAgICBpZiAoY291bnRlcikge1xuICAgICAgdGhpcy5zZW5kKGNvdW50ZXIubmFtZSwgY291bnRlci50b0pTT04oKSwgdGltZXN0YW1wKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgcmVwb3J0TWV0ZXIobWV0ZXIsIHRpbWVzdGFtcCkge1xuICAgIGlmIChtZXRlcikge1xuICAgICAgdGhpcy5yZXBvcnRNZXRlck1ldHJpY3MobWV0ZXIubmFtZSwgbWV0ZXIudG9KU09OKCksIHRpbWVzdGFtcCk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIHJlcG9ydEhpc3RvZ3JhbShoaXN0b2dyYW0sIHRpbWVzdGFtcCkge1xuICAgIGlmIChoaXN0b2dyYW0pIHtcbiAgICAgIC8vIFJlcG9ydCBjb3VudCBzZXBhcmF0ZWx5IGFzIHJlcG9ydEhpc3RvZ3JhbU1ldHJpY3MgaXMgYWxzbyB1c2VkIGJ5IFRpbWVyLlxuICAgICAgdGhpcy5zZW5kKGAke2hpc3RvZ3JhbS5uYW1lfS5jb3VudGAsIGhpc3RvZ3JhbS5jb3VudCwgdGltZXN0YW1wKTtcbiAgICAgIHRoaXMucmVwb3J0SGlzdG9ncmFtTWV0cmljcyhoaXN0b2dyYW0ubmFtZSwgaGlzdG9ncmFtLnRvSlNPTigpLCB0aW1lc3RhbXApO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyByZXBvcnRUaW1lcih0aW1lciwgdGltZXN0YW1wKSB7XG4gICAgaWYgKHRpbWVyKSB7XG4gICAgICBjb25zdCB0aW1lck9iamVjdCA9IHRpbWVyLnRvSlNPTigpO1xuICAgICAgY29uc3QgbWV0ZXIgPSB0aW1lck9iamVjdC5tZXRlcjtcbiAgICAgIGNvbnN0IGhpc3RvZ3JhbSA9IHRpbWVyT2JqZWN0Lmhpc3RvZ3JhbTtcbiAgICAgIHRoaXMucmVwb3J0TWV0ZXJNZXRyaWNzKHRpbWVyLm5hbWUsIG1ldGVyLCB0aW1lc3RhbXApO1xuICAgICAgdGhpcy5yZXBvcnRIaXN0b2dyYW1NZXRyaWNzKHRpbWVyLm5hbWUsIGhpc3RvZ3JhbSwgdGltZXN0YW1wKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgcmVwb3J0TWV0ZXJNZXRyaWNzKG5hbWUsIG1ldGVyT2JqZWN0LCB0aW1lc3RhbXApIHtcbiAgICB0aGlzLnNlbmQoYCR7bmFtZX0uY291bnRgLCBtZXRlck9iamVjdC5jb3VudCwgdGltZXN0YW1wKTtcbiAgICB0aGlzLnNlbmQoYCR7bmFtZX0ubWVhbl9yYXRlYCwgbWV0ZXJPYmplY3QubWVhbiwgdGltZXN0YW1wKTtcbiAgICB0aGlzLnNlbmQoYCR7bmFtZX0ubTFfcmF0ZWAsIG1ldGVyT2JqZWN0WycxTWludXRlUmF0ZSddLCB0aW1lc3RhbXApO1xuICAgIHRoaXMuc2VuZChgJHtuYW1lfS5tNV9yYXRlYCwgbWV0ZXJPYmplY3RbJzVNaW51dGVSYXRlJ10sIHRpbWVzdGFtcCk7XG4gICAgdGhpcy5zZW5kKGAke25hbWV9Lm0xNV9yYXRlYCwgbWV0ZXJPYmplY3RbJzE1TWludXRlUmF0ZSddLCB0aW1lc3RhbXApO1xuICB9XG5cbiAgcHVibGljIHJlcG9ydEhpc3RvZ3JhbU1ldHJpY3MobmFtZSwgaGlzdG9ncmFtT2JqZWN0LCB0aW1lc3RhbXApIHtcbiAgICBPYmplY3Qua2V5cyhoaXN0b2dyYW1PYmplY3QpLmZvckVhY2goa2V5ID0+IHtcbiAgICAgIHRoaXMuc2VuZChgJHtuYW1lfS4ke2tleX1gLCBoaXN0b2dyYW1PYmplY3Rba2V5XSwgdGltZXN0YW1wKTtcbiAgICB9KTtcbiAgfVxufVxuIl19