"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const net_1 = require("net");
const reporter_1 = require("./reporter");
class GraphiteReporter extends reporter_1.Reporter {
    constructor(interval = 6000, host = process.env.GRAPHITE_HOST || 'localhost', port = process.env.GRAPHITE_PORT || '2003', prefix = 'app') {
        super(interval);
        this.host = host;
        this.port = port;
        this.prefix = prefix;
        this.socket = new net_1.Socket();
        this.reconnecting = false;
    }
    start() {
        this.socket.on('error', error => {
            if (!this.reconnecting) {
                this.reconnecting = true;
                this.emit('log', 'warn', `Lost connection to ${this.host}. Reconnect in 10 seconds: ${error}`);
                this.stop();
                setTimeout(() => {
                    this.reconnecting = false;
                    this.start();
                }, 10000);
            }
        });
        this.emit('log', 'verbose', `Connecting to graphite @ ${this.host}:${this.port}.`);
        this.socket.connect(parseInt(this.port), this.host, () => {
            this.emit('log', 'verbose', `Successfully connected to graphite @ ${this.host}:${this.port}.`);
            this.interval = setInterval(() => {
                this.report();
            }, this.reportInterval);
        });
    }
    stop() {
        if (this.interval) {
            clearInterval(this.interval);
        }
        this.socket.end();
    }
    report() {
        if (this.reconnecting)
            return;
        const timestamp = Date.now() / 1000;
        const metrics = this.getMetrics();
        if (metrics.gauges.length !== 0) {
            metrics.gauges.forEach(gauge => {
                this.reportGauge(gauge, timestamp);
            });
        }
        if (metrics.meters.length !== 0) {
            metrics.meters.forEach(meter => {
                this.reportMeter(meter, timestamp);
            });
        }
        if (metrics.timers.length !== 0) {
            metrics.timers.forEach(timer => {
                this.reportTimer(timer, timestamp);
            });
        }
        if (metrics.counters.length !== 0) {
            metrics.counters.forEach(counter => {
                this.reportCounter(counter, timestamp);
            });
        }
        if (metrics.histograms.length !== 0) {
            metrics.histograms.forEach(histogram => {
                this.reportHistogram(histogram, timestamp);
            });
        }
    }
    send(name, value, timestamp) {
        if (this.reconnecting)
            return;
        this.socket.write(`${this.prefix}.${name} ${value} ${timestamp}\n`);
    }
    reportGauge(gauge, timestamp) {
        if (gauge) {
            this.send(gauge.name, gauge.toJSON(), timestamp);
        }
    }
    reportCounter(counter, timestamp) {
        if (counter) {
            this.send(counter.name, counter.toJSON(), timestamp);
        }
    }
    reportMeter(meter, timestamp) {
        if (meter) {
            this.reportMeterMetrics(meter.name, meter.toJSON(), timestamp);
        }
    }
    reportHistogram(histogram, timestamp) {
        if (histogram) {
            this.send(`${histogram.name}.count`, histogram.count, timestamp);
            this.reportHistogramMetrics(histogram.name, histogram.toJSON(), timestamp);
        }
    }
    reportTimer(timer, timestamp) {
        if (timer) {
            const timerObject = timer.toJSON();
            const meter = timerObject.meter;
            const histogram = timerObject.histogram;
            this.reportMeterMetrics(timer.name, meter, timestamp);
            this.reportHistogramMetrics(timer.name, histogram, timestamp);
        }
    }
    reportMeterMetrics(name, meterObject, timestamp) {
        this.send(`${name}.count`, meterObject.count, timestamp);
        this.send(`${name}.mean_rate`, meterObject.mean, timestamp);
        this.send(`${name}.m1_rate`, meterObject['1MinuteRate'], timestamp);
        this.send(`${name}.m5_rate`, meterObject['5MinuteRate'], timestamp);
        this.send(`${name}.m15_rate`, meterObject['15MinuteRate'], timestamp);
    }
    reportHistogramMetrics(name, histogramObject, timestamp) {
        Object.keys(histogramObject).forEach(key => {
            this.send(`${name}.${key}`, histogramObject[key], timestamp);
        });
    }
}
exports.GraphiteReporter = GraphiteReporter;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ3JhcGhpdGUtcmVwb3J0ZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvZ3JhcGhpdGUtcmVwb3J0ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSw2QkFBNkI7QUFFN0IseUNBQXNDO0FBRXRDLE1BQWEsZ0JBQWlCLFNBQVEsbUJBQVE7SUFHNUMsWUFDRSxXQUFtQixJQUFJLEVBQ2YsT0FBZSxPQUFPLENBQUMsR0FBRyxDQUFDLGFBQWEsSUFBSSxXQUFXLEVBQ3ZELE9BQWUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxhQUFhLElBQUksTUFBTSxFQUNsRCxTQUFpQixLQUFLO1FBRTlCLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUpSLFNBQUksR0FBSixJQUFJLENBQW1EO1FBQ3ZELFNBQUksR0FBSixJQUFJLENBQThDO1FBQ2xELFdBQU0sR0FBTixNQUFNLENBQWdCO1FBTnhCLFdBQU0sR0FBVyxJQUFJLFlBQU0sRUFBRSxDQUFDO1FBQzlCLGlCQUFZLEdBQVksS0FBSyxDQUFDO0lBUXRDLENBQUM7SUFFTSxLQUFLO1FBQ1YsSUFBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsT0FBTyxFQUFFLEtBQUssQ0FBQyxFQUFFO1lBQzlCLElBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxFQUFFO2dCQUN0QixJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQztnQkFDekIsSUFBSSxDQUFDLElBQUksQ0FDUCxLQUFLLEVBQ0wsTUFBTSxFQUNOLHNCQUFzQixJQUFJLENBQUMsSUFBSSw4QkFBOEIsS0FBSyxFQUFFLENBQ3JFLENBQUM7Z0JBRUYsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO2dCQUNaLFVBQVUsQ0FBQyxHQUFHLEVBQUU7b0JBQ2QsSUFBSSxDQUFDLFlBQVksR0FBRyxLQUFLLENBQUM7b0JBQzFCLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQztnQkFDZixDQUFDLEVBQUUsS0FBSyxDQUFDLENBQUM7YUFDWDtRQUNI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QUM7Q0FDRjtBQTVJRCw0Q0E0SUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBTb2NrZXQgfSBmcm9tICduZXQnO1xuXG5pbXBvcnQgeyBSZXBvcnRlciB9IGZyb20gJy4vcmVwb3J0ZXInO1xuXG5leHBvcnQgY2xhc3MgR3JhcGhpdGVSZXBvcnRlciBleHRlbmRzIFJlcG9ydGVyIHtcbiAgcHJpdmF0ZSBzb2NrZXQ6IFNvY2tldCA9IG5ldyBTb2NrZXQoKTtcbiAgcHJpdmF0ZSByZWNvbm5lY3Rpbmc6IGJvb2xlYW4gPSBmYWxzZTtcbiAgY29uc3RydWN0b3IoXG4gICAgaW50ZXJ2YWw6IG51bWJlciA9IDYwMDAsXG4gICAgcHJpdmF0ZSBob3N0OiBzdHJpbmcgPSBwcm9jZXNzLmVudi5HUkFQSElURV9IT1NUIHx8ICdsb2NhbGhvc3QnLFxuICAgIHByaXZhdGUgcG9ydDogc3RyaW5nID0gcHJvY2Vzcy5lbnYuR1JBUEhJVEVfUE9SVCB8fCAnMjAwMycsXG4gICAgcHJpdmF0ZSBwcmVmaXg6IHN0cmluZyA9ICdhcHAnXG4gICkge1xuICAgIHN1cGVyKGludGVydmFsKTtcbiAgfVxuXG4gIHB1YmxpYyBzdGFydCgpIHtcbiAgICB0aGlzLnNvY2tldC5vbignZXJyb3InLCBlcnJvciA9PiB7XG4gICAgICBpZiAoIXRoaXMucmVjb25uZWN0aW5nKSB7XG4gICAgICAgIHRoaXMucmVjb25uZWN0aW5nID0gdHJ1ZTtcbiAgICAgICAgdGhpcy5lbWl0KFxuICAgICAgICAgICdsb2cnLFxuICAgICAgICAgICd3YXJuJyxcbiAgICAgICAgICBgTG9zdCBjb25uZWN0aW9uIHRvICR7dGhpcy5ob3N0fS4gUmVjb25uZWN0IGluIDEwIHNlY29uZHM6ICR7ZXJyb3J9YFxuICAgICAgICApO1xuICAgICAgICAvLyBTdG9wIHRoZSByZXBvcnRlciBhbmQgdHJ5IGFnYWluIGluIGEgZmV3IHNlY29uZHMuXG4gICAgICAgIHRoaXMuc3RvcCgpO1xuICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICB0aGlzLnJlY29ubmVjdGluZyA9IGZhbHNlO1xuICAgICAgICAgIHRoaXMuc3RhcnQoKTtcbiAgICAgICAgfSwgMTAwMDApO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgdGhpcy5lbWl0KCdsb2cnLCAndmVyYm9zZScsIGBDb25uZWN0aW5nIHRvIGdyYXBoaXRlIEAgJHt0aGlzLmhvc3R9OiR7dGhpcy5wb3J0fS5gKTtcbiAgICB0aGlzLnNvY2tldC5jb25uZWN0KFxuICAgICAgcGFyc2VJbnQodGhpcy5wb3J0KSxcbiAgICAgIHRoaXMuaG9zdCxcbiAgICAgICgpID0+IHtcbiAgICAgICAgdGhpcy5lbWl0KFxuICAgICAgICAgICdsb2cnLFxuICAgICAgICAgICd2ZXJib3NlJyxcbiAgICAgICAgICBgU3VjY2Vzc2Z1bGx5IGNvbm5lY3RlZCB0byBncmFwaGl0ZSBAICR7dGhpcy5ob3N0fToke3RoaXMucG9ydH0uYFxuICAgICAgICApO1xuICAgICAgICB0aGlzLmludGVydmFsID0gc2V0SW50ZXJ2YWwoKCkgPT4ge1xuICAgICAgICAgIHRoaXMucmVwb3J0KCk7XG4gICAgICAgIH0sIHRoaXMucmVwb3J0SW50ZXJ2YWwpO1xuICAgICAgfVxuICAgICk7XG4gIH1cblxuICBzdG9wKCkge1xuICAgIGlmICh0aGlzLmludGVydmFsKSB7XG4gICAgICBjbGVhckludGVydmFsKHRoaXMuaW50ZXJ2YWwpO1xuICAgIH1cbiAgICB0aGlzLnNvY2tldC5lbmQoKTtcbiAgfVxuXG4gIHB1YmxpYyByZXBvcnQoKSB7XG4gICAgaWYgKHRoaXMucmVjb25uZWN0aW5nKSByZXR1cm47XG4gICAgY29uc3QgdGltZXN0YW1wID0gRGF0ZS5ub3coKSAvIDEwMDA7XG4gICAgY29uc3QgbWV0cmljcyA9IHRoaXMuZ2V0TWV0cmljcygpO1xuXG4gICAgaWYgKG1ldHJpY3MuZ2F1Z2VzLmxlbmd0aCAhPT0gMCkge1xuICAgICAgbWV0cmljcy5nYXVnZXMuZm9yRWFjaChnYXVnZSA9PiB7XG4gICAgICAgIHRoaXMucmVwb3J0R2F1Z2UoZ2F1Z2UsIHRpbWVzdGFtcCk7XG4gICAgICB9KTtcbiAgICB9XG4gICAgaWYgKG1ldHJpY3MubWV0ZXJzLmxlbmd0aCAhPT0gMCkge1xuICAgICAgbWV0cmljcy5tZXRlcnMuZm9yRWFjaChtZXRlciA9PiB7XG4gICAgICAgIHRoaXMucmVwb3J0TWV0ZXIobWV0ZXIsIHRpbWVzdGFtcCk7XG4gICAgICB9KTtcbiAgICB9XG4gICAgaWYgKG1ldHJpY3MudGltZXJzLmxlbmd0aCAhPT0gMCkge1xuICAgICAgbWV0cmljcy50aW1lcnMuZm9yRWFjaCh0aW1lciA9PiB7XG4gICAgICAgIHRoaXMucmVwb3J0VGltZXIodGltZXIsIHRpbWVzdGFtcCk7XG4gICAgICB9KTtcbiAgICB9XG4gICAgaWYgKG1ldHJpY3MuY291bnRlcnMubGVuZ3RoICE9PSAwKSB7XG4gICAgICBtZXRyaWNzLmNvdW50ZXJzLmZvckVhY2goY291bnRlciA9PiB7XG4gICAgICAgIHRoaXMucmVwb3J0Q291bnRlcihjb3VudGVyLCB0aW1lc3RhbXApO1xuICAgICAgfSk7XG4gICAgfVxuICAgIGlmIChtZXRyaWNzLmhpc3RvZ3JhbXMubGVuZ3RoICE9PSAwKSB7XG4gICAgICBtZXRyaWNzLmhpc3RvZ3JhbXMuZm9yRWFjaChoaXN0b2dyYW0gPT4ge1xuICAgICAgICB0aGlzLnJlcG9ydEhpc3RvZ3JhbShoaXN0b2dyYW0sIHRpbWVzdGFtcCk7XG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHNlbmQobmFtZSwgdmFsdWUsIHRpbWVzdGFtcCkge1xuICAgIGlmICh0aGlzLnJlY29ubmVjdGluZykgcmV0dXJuO1xuICAgIHRoaXMuc29ja2V0LndyaXRlKGAke3RoaXMucHJlZml4fS4ke25hbWV9ICR7dmFsdWV9ICR7dGltZXN0YW1wfVxcbmApO1xuICB9XG5cbiAgcHVibGljIHJlcG9ydEdhdWdlKGdhdWdlLCB0aW1lc3RhbXApIHtcbiAgICBpZiAoZ2F1Z2UpIHtcbiAgICAgIHRoaXMuc2VuZChnYXVnZS5uYW1lLCBnYXVnZS50b0pTT04oKSwgdGltZXN0YW1wKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgcmVwb3J0Q291bnRlcihjb3VudGVyLCB0aW1lc3RhbXApIHtcbiAgICBpZiAoY291bnRlcikge1xuICAgICAgdGhpcy5zZW5kKGNvdW50ZXIubmFtZSwgY291bnRlci50b0pTT04oKSwgdGltZXN0YW1wKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgcmVwb3J0TWV0ZXIobWV0ZXIsIHRpbWVzdGFtcCkge1xuICAgIGlmIChtZXRlcikge1xuICAgICAgdGhpcy5yZXBvcnRNZXRlck1ldHJpY3MobWV0ZXIubmFtZSwgbWV0ZXIudG9KU09OKCksIHRpbWVzdGFtcCk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIHJlcG9ydEhpc3RvZ3JhbShoaXN0b2dyYW0sIHRpbWVzdGFtcCkge1xuICAgIGlmIChoaXN0b2dyYW0pIHtcbiAgICAgIC8vIFJlcG9ydCBjb3VudCBzZXBhcmF0ZWx5IGFzIHJlcG9ydEhpc3RvZ3JhbU1ldHJpY3MgaXMgYWxzbyB1c2VkIGJ5IFRpbWVyLlxuICAgICAgdGhpcy5zZW5kKGAke2hpc3RvZ3JhbS5uYW1lfS5jb3VudGAsIGhpc3RvZ3JhbS5jb3VudCwgdGltZXN0YW1wKTtcbiAgICAgIHRoaXMucmVwb3J0SGlzdG9ncmFtTWV0cmljcyhoaXN0b2dyYW0ubmFtZSwgaGlzdG9ncmFtLnRvSlNPTigpLCB0aW1lc3RhbXApO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyByZXBvcnRUaW1lcih0aW1lciwgdGltZXN0YW1wKSB7XG4gICAgaWYgKHRpbWVyKSB7XG4gICAgICBjb25zdCB0aW1lck9iamVjdCA9IHRpbWVyLnRvSlNPTigpO1xuICAgICAgY29uc3QgbWV0ZXIgPSB0aW1lck9iamVjdC5tZXRlcjtcbiAgICAgIGNvbnN0IGhpc3RvZ3JhbSA9IHRpbWVyT2JqZWN0Lmhpc3RvZ3JhbTtcbiAgICAgIHRoaXMucmVwb3J0TWV0ZXJNZXRyaWNzKHRpbWVyLm5hbWUsIG1ldGVyLCB0aW1lc3RhbXApO1xuICAgICAgdGhpcy5yZXBvcnRIaXN0b2dyYW1NZXRyaWNzKHRpbWVyLm5hbWUsIGhpc3RvZ3JhbSwgdGltZXN0YW1wKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgcmVwb3J0TWV0ZXJNZXRyaWNzKG5hbWUsIG1ldGVyT2JqZWN0LCB0aW1lc3RhbXApIHtcbiAgICB0aGlzLnNlbmQoYCR7bmFtZX0uY291bnRgLCBtZXRlck9iamVjdC5jb3VudCwgdGltZXN0YW1wKTtcbiAgICB0aGlzLnNlbmQoYCR7bmFtZX0ubWVhbl9yYXRlYCwgbWV0ZXJPYmplY3QubWVhbiwgdGltZXN0YW1wKTtcbiAgICB0aGlzLnNlbmQoYCR7bmFtZX0ubTFfcmF0ZWAsIG1ldGVyT2JqZWN0WycxTWludXRlUmF0ZSddLCB0aW1lc3RhbXApO1xuICAgIHRoaXMuc2VuZChgJHtuYW1lfS5tNV9yYXRlYCwgbWV0ZXJPYmplY3RbJzVNaW51dGVSYXRlJ10sIHRpbWVzdGFtcCk7XG4gICAgdGhpcy5zZW5kKGAke25hbWV9Lm0xNV9yYXRlYCwgbWV0ZXJPYmplY3RbJzE1TWludXRlUmF0ZSddLCB0aW1lc3RhbXApO1xuICB9XG5cbiAgcHVibGljIHJlcG9ydEhpc3RvZ3JhbU1ldHJpY3MobmFtZSwgaGlzdG9ncmFtT2JqZWN0LCB0aW1lc3RhbXApIHtcbiAgICBPYmplY3Qua2V5cyhoaXN0b2dyYW1PYmplY3QpLmZvckVhY2goa2V5ID0+IHtcbiAgICAgIHRoaXMuc2VuZChgJHtuYW1lfS4ke2tleX1gLCBoaXN0b2dyYW1PYmplY3Rba2V5XSwgdGltZXN0YW1wKTtcbiAgICB9KTtcbiAgfVxufVxuIl19